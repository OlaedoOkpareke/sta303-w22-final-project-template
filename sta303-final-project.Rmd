---
title: "Report on MINGAR Customers and Device Functionability"
subtitle: "MINGAR devices over-flag darker skin tones, marketing results here"
author: "Report prepared for MINGAR by Arpesso"
date: 2022-04-07
lang: "en"
output:
  pdf_document:
    template: report.tex
    toc: true
    toc_depth: 2
titlepage: true
titlepage-color: "6C3082"
titlepage-text-color: "FFFFFF"
titlepage-rule-color: "FFFFFF"
titlepage-rule-height: 2
---

```{r, message = FALSE, echo=FALSE}
library(tidyverse)
library(lme4)
library(rvest)
library(polite)
library(lmtest)

# this should suppress all code and messages
knitr::opts_chunk$set(include=FALSE)
```


_The cover page must be a single stand alone page and have:_

*	_A title and subtitle (that indicate your findings)_
* _"Report prepared for MINGAR by" your company name_
*	_Date (assessment submission date is fine)_

_You can change the colour of this cover to any colour you would like by replacing 6C3082 in the YAML above (`titlepage-color:`) to another hex code. You could use this tool to help you:_ https://htmlcolorcodes.com/color-picker/

_Note: There should NOT be a table of contents on the cover page. It should look like a cover._

\newpage
# Executive summary

_Guidelines for the executive summary:_

* _No more than two pages_
* _Language is appropriate for a non-technical audience_
* _Bullet points are used where appropriate_
*	_A small number of key visualizations and/or tables are included_
*	_All research questions are addressed_


_The [module 4 writing prompt](https://sta303-bolton.github.io/sta303-w22-courseguide/knowledge-basket-writing-and-peer-feedback.html#module-4-writing-task) provides some tips and information about writing executive summaries._


\newpage
# Technical report
_This part of the report is much more comprehensive than the executive summary. The audience is statistics/data-minded people, but you should NOT include code or unformatted R output here._


## Introduction

_Provide a brief introduction to your report and outline what the report will cover. This section is valuable for setting scope and expectations. _

### Research questions
_Use bullet points to to describe the research questions you are going to address. Write in full sentences._

* _What are the differences between customers buying affordable fitness trackers/smart watches and those who don't?_

* After accounting for other possible explanations, are Mingar devices more likely to  flag darker skinned users of their sleep devices more than lighter skinned users per minute of sleep? 


## Mingar Devices are more likely to flag darker skinned users than lighter skinned users

_For each research question, you will want to briefly describe any data manipulation, show some exploratory plots/summary tables, report on any methods you use (i.e. models you fit) and the conclusions you draw from these_

### The Data
In this report we create a model to find the relationship between the sleep scores of an individual and their skin tone, accounting for the duration of sleep. We also visualize and analyze the data that shows the relationship between these flags and possible explanatory variables. We use the MINGAR customer datasets, datasets on device, and data on sleep flags for people with MINGAR devices. We use the emoji variable as a proxy for skin tone. 

Our variable of interest is the number of flags during a night of sleep for each person. We see that the distribution of this variable is approximately poisson as it is right skewed with many values at 0. From the figure below it appears that people with darker skin tones get more quality flags during sleep than people of lighter skin tones. There are also many people whose true skin tone is not recorded.

```{r, echo = FALSE, fig.cap = "Distribution of sleep disruption flags by skin tone"}
cust_full %>%
  ggplot(data =., aes(x=flags, fill = emoji_modifier)) +
  geom_histogram()+ 
  theme_minimal() +
  labs(x = "Flags",
       y = "Count",
       fill = "Skin Tone") +
  scale_fill_brewer(palette = "Set1", labels = c("Lightest", "Medium-Light", "Medium", "Medium-Dark", "Darkest"))
```

The following table shows the summary on number of flags for all wearers of the devices over the several nights. The count is the number of times that flags happened per night, and the rate is the number of flags per minute of sleep. We see that the mean and variance of both counts and rates for darker skinned people tends to be larger than lighter skinned people. This indicates that MINGAR might have a problem with darker skinned people getting flagged more often. As the mean and variance are close for the most part, we can assume that this assumption for the poisson distribution is satisfied.  

```{r, echo = FALSE}
cust_full %>%
    group_by(emoji_modifier) %>%
    dplyr::summarize(MeanCount = mean(flags, na.rm=TRUE),
              VarCount = var(flags, na.rm=TRUE),
              MeanRate = mean(flags/duration, na.rm=TRUE),
              VarRate = var(flags/duration, na.rm=TRUE)) %>%
  knitr::kable(booktabs=T,
               col.names = c("Skin Tone", "Mean Count", "Variance of Count", "Mean Rate", "Variance of Rate"),
             caption = 'The mean and variance for number of flags and rate of flags by skin tone.') 
```

Looking at the proportion of people in the data, we see that lighter skinned people have more more information on sleep flags than darker skinned people.
```{r, echo = FALSE}
with(cust_full,(prop.table(table(emoji_modifier)))) %>% 
  knitr::kable(col.names = c("Skin Tone", "Frequency"), caption = 'Proportion of people with sleep flag data in each skin tone group.')
```
### Methods

* state what types of model we're looking to assume, eg is it assumption for poisson, for glmm, etc * 
We previously confirmed the assumptions from the graph and table that the sleep flags are of the poisson distribution. We assume that the people who purchased the sleep tracking devices made the decision independently, that is, our subjects are independent. As the different flags that each subject gets are likely not independent, we use a random effect to account for the violation of independence. We assume that the  residual errors come from a normal distribution and have a constant variance, proven by the residual plot. As we have shown that the flag distribution is poisson, we assume that the log link used to link this response to the explanatory variables is correct. However, we cannot assume that our random effect is normal.  

To create the main dataset, we merged the customer information data, the sleep data, and the customer device data. To create the possible explanatory models, we created an age variable by subtracting the date of birth of the individual from the date of analysis; March 30th 2022. For further visualization, we divided the ages into separate age groups by decade. We renamed the emoji variables to understandable skin tones, and removed all missing values in this variable. We dropped all missing values for the sex variable to make the two possible explanatory models formed comparable in size. 

We used generalized linear mixed models to estimate the relationships between sleep flags and explanatory variables. Our first possible model included all the characteristics of the individual and the device, to make sure that the problem was not caused by problems inherent to the type of device, or other characteristics of the individual. These variables included skin tone, sex, age, and the device type. Running the summary on this model showed that the sex of the individual and the device type were statistically insignificant at a 5% significance level. Our second model only had the variables on skin tone and age. Running the model showed both these variables as statistically significant at a 5% level. We used a likelihood ratio test on the two models, as the assumptions needed for this type of test do not include normality or independence. The test revealed that at a p value of 0.2137, there was no evidence against the null hypothesis that the model involving only skin tone and age was better than the model that included the other variables. A residual plot of this model shows that the residual plots look scattered with no fanning, indicating constant variance of errors. Due to the poisson nature of the response when analyzing our model results we exponentiate the results  in order to interpret the coefficients.

### Model

Our final model is $$ log(\lambda)_j = \beta_1\alpha_{1ij} + \beta_2\alpha_{2ij} + \gamma_{ij} + log(duration)_{ij} $$ 

* how do i write this model? is there supposed to be an error term? *
Where: 
$ \lambda$ is the mean number of flags for day j of sleep
$\alpha_{1ij}$ is the skin tone of person i on day j. This is a fixed effect. 
$\alpha_{2ij}$ is the age of person i on day j. This is also a fixed effect. 
$\gamma_{ij}$ is the customer id of person i on day j. This is a random effect added to account for the fact that flags for the same person will likely not be independent.
$duration$ is offset by duration, to account for the different minutes of sleep people have, so they may have different rates of flags. 

### Results

We perform individual t tests to check if the proportion of people being flagged is similar across skin color. The null hypothesis is that the mean number of flags for each group is the same. As the p value is $2.2e^{16}$, we reject the null hypothesis and determine that some groups get flagged more than others. That is, skin tone does have an effect on the number of flags a person gets. 
```{r,echo=FALSE}
# Are the proportions of people being flagged  similar across race?
prop.table(table(cust_full$emoji_modifier, cust_full$flags), 1)
chisq.test(cust_full$emoji_modifier, cust_full$flags)
```


The following table shows the results of the regression with our chosen model. The table includes the point estimates, as well as the 95% confidence interval range to account for variability in sampling. 

We have set the lightest skin tone as the base factor level.  We see holding age constant and accounting for the duration of sleep and dependence of observations within the same individual, that the darker the subject's skin is, the more likely that they get flagged.
The mean number of flags for medium-light skinned people, medium skinned people, medium-dark skinned people, and dark skinned people are 2.173, 3.248, 6.624, and 10.913 times higher than the mean number of flags for light skinned people respectively. Thus according to the results MINGAR devices do have a problem with flagging darker skinned people. A secondary observation is that holding skin tone constant, the older one gets, the less likely they are to be flagged. The mean number of flags increases by a factor of 0.999 (or decreases by 0.06%)for each additional age.   

```{r}
# par_table = cbind(est = summary(modrace2)$coef[,1],confint(modrace2))

#round(exp(par_table),3) %>% knitr::kable(caption = "table.")

```
The following plot helps visualize the previous results. We see that the lightest skin tone mainly hangs around the low end of the number of flags, with about 50% of people with 0 flags having this skin tone. The proportion of people with a low number of flags decreases as the skin tone gets darker. We see that the two darkest skin tones make up the largest proportion of people who get many quality flags a night. 
```{r, echo = FALSE, fig.cap = "Proportion of People with flags by skin tone}
ggplot(data = cust_full, aes(x = flags, fill = emoji_modifier)) +
  geom_bar(position = "fill") +
  scale_fill_grey() +
  theme_minimal() +
  labs(fill = "Skin Tone", x = "Flags", y = "Proportion")
```
```{r, echo = FALSE}
cust_full %>% 
  ggplot(aes(x = flags, fill = emoji_modifier),position="fill") +
  geom_bar(position = "fill") +
  scale_fill_grey() +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(palette = "Spectral", labels = c("Lightest", "Medium-Light", "Medium", "Medium-Dark", "Darkest"))
```

This plot shows the estimated relationship between the log mean value of flags and the age of the person. The plot also shows the confidence intervals around the line. The log of the y axis is taken due to the poisson nature of the response. Due to the negative slope, we see that the younger one is, the more likely they are to have a larger mean number of flags. Thus there is a negative relationship between these two variables, holding skin tone constant. 

```{r, echo = FALSE}
plot <- cust_full %>% group_by(age) %>% 
  summarise(mnflag = mean(flags),
            logmnflag = log(mnflag), n=n())
ggplot(plot, aes(x=age, y=logmnflag)) +
  geom_point()+
  geom_smooth(method = "loess", size = 1)+
  xlab("Age of the person") +
  ylab("Log of the empirical mean number of flags") +
  theme_minimal()
```



## Informative title for section addressing a research question

* _Affordable items are defined True when products are of the lines "Active" or "Advance" and False otherwise._
* _This makes Affordable items a binomial variable so we can use the binomial distribution for the model._
* _We define differences in customers by their income, age, gender,and specific device features by model._
* _We define income group based on the Quantiles of the dataset._

## Discussion

_In this section you will summarize your findings across all the research questions and discuss the strengths and limitations of your work. It doesn't have to be long, but keep in mind that often people will just skim the intro and the discussion of a document like this, so make sure it is useful as a semi-standalone section (doesn't have to be completely standalone like the executive summary)._

### Findings

For the question on the relationship between sleep scores and skin tones, we have confirmed that the reports were correct. MINGAR devices are far more likely to flag an individual the darker their skin is, provided that age stays constant.
We find that the average number of flags during sleep for medium-light, medium, medium-dark, and dark skinned people are 2.173, 3.248, 6.624, and 10.913 times higher than the mean number of flags for light skinned people respectively. This accounts for the duration of sleep, and age staying constant. We have also found that the age of the individual affects the mean number of flags they get, with the mean number of flags increasing by a factor of 0.999 (or decreases by 0.06%) for each additional age, skin tone held constant. 

### Strengths and limitations
There were several limitations when analyzing the information on skin tones and flags. 
The first major limitation is that the missing values (default skin tone emoji) was not accurate to the actual skin tone of the individual. As their true skin tone was not recorded, these individuals were dropped from the model, and analysis created is most likely biased as we dropped a large number of the observations. This means that  we do not know the true relationship between skin tones and sleep scores.

Another limitation is that it is possible that the skin tone emoji a person uses is not their actual skin tone. As it is impossible to verify as a race variable was not included, the analysis may be biased as we do not get the true relationship between skin tone and flags.

Another limitation is that while the mean and median flags for each skin tone was close, they were not very close. This may violate the poisson assumption  that mean most always be equal to variance. This means that there may be overdispersion of coefficients (coefficients reported are larger than their true variable).

We also dropped all observations in which sex was missing. This could cause bias in the model if the missing variables were not randomly distributed. 

A main assumption for the type of model used is that the random effects need to come from a normal distribution. However as our random effects was the customer id, which is unique to each customer,the distribution is uniform. Thus our estimates are likely biased. 

* Postcode measures are not perfectly comparable for a single person, but gives the general area of the wealthj in that neighbourhood *

\newpage

# Consultant information

## Consultant profiles


**Thomas D'Onofrio** Statsy is a senior consultant with Eminence Analytics. She specializes in data visualization. Statsy earned her Bachelor of Science, Specialist in Statistics Methods and Practice, from the University of Toronto in 2023.

**Pablo Mercado**. Statsy is a senior consultant with Eminence Analytics. She specializes in data visualization. Statsy earned her Bachelor of Science, Specialist in Statistics Methods and Practice, from the University of Toronto in 2023.

**Olaedo Okpareke**. Olaedo Okpareke is a senior consultant at Arpesso Analytics. She specializes in statistical analysis and data visualization in R and Python. She also specializes in statistical surveys and sampling, as well as financial risk analysis. Olaedo earned her Bachelor of Science in Economics and Statistics from the University of Toronto in 2023, and her masters in Economic Data analysis from University of Toronto in 2026. 

**Walid Roudani**. Walid Roudani is a senior consultant with Arpesso Analytics. He specializes in reproducible analysis, statistical communication, as well as team organization. Walid has earned both his Bachelor of Science in Economics and Statistics from the University of Toronto in 2023, as well as his masters degree in Economics at the University of Toronto in 2026.

## Code of ethical conduct

In our report, we represented all summaries and visualizations honestly. We did not create any misleading visualizations. When modifications to variables were made, they were very explicitly stated and justified. We stated clearly all limitations of the analysis, and any failings of our method. 

We did not disclose any personal customer information from MINGAR to any third party, as disclosed by the Non-disclosure agreement. All confidential information was analyzed solely by the statistic consultants for the report at Arpesso. As no consent was given by MINGAR to spread the customer information, and was not directed by the court of law, the information was kept confidential. 

In preparing the report, Arpesso remained objective with handling of the data, and did not modify any variables or give false results to uphold personal biases. The statistical procedures used to create the data was done based on the data itself and not on personal decisions.

While scraping the data required for our report, we made sure to uphold the rights of the owner by providing a user agent string for further inquiries, and so that our requests are made clear. We scraped the data at a timely rate, made sure to not pass the data off as our own, and scraped to create new datasets from the data, not to duplicate it. 

All sensitive customer information was kept anonymized. Arpesso did not attempt to use the information to identify individuals. To uphold customer's privacy, all personal information was used solely for the purpose of analysis and no non-essential identifying information was used.

\newpage
# References

1. R Core Team (2021). R: A language and environment for statistical computing.
  R Foundation for Statistical Computing, Vienna, Austria. URL
  https://www.R-project.org/.
  
2. Wickham et al., (2019). Welcome to the tidyverse. Journal of Open Source
  Software, 4(43), 1686, https://doi.org/10.21105/joss.01686
  
3. Douglas Bates, Martin Maechler, Ben Bolker, Steve Walker (2015). Fitting
  Linear Mixed-Effects Models Using lme4. Journal of Statistical Software,
  67(1), 1-48. doi:10.18637/jss.v067.i01.

4. adley Wickham (2021). rvest: Easily Harvest (Scrape) Web Pages.
  https://rvest.tidyverse.org/, https://github.com/tidyverse/rvest.
  
5. Dmytro Perepolkin (2019). polite: Be Nice on the Web. R package version
  0.1.1. https://github.com/dmi3kno/polite  
  
6. Achim Zeileis, Torsten Hothorn (2002). Diagnostic Checking in Regression
  Relationships. R News 2(3), 7-10. URL https://CRAN.R-project.org/doc/Rnews/
  
7. Sam Firke (2021). janitor: Simple Tools for Examining and Cleaning Dirty
  Data. R package version 2.1.0. https://github.com/sfirke/janitor
  
8. Hadley Wickham and Evan Miller (2021). haven: Import and Export 'SPSS',
  'Stata' and 'SAS' Files. https://haven.tidyverse.org,
  https://github.com/tidyverse/haven, https://github.com/WizardMac/ReadStat.
  
9. von Bergmann, J., Dmitry Shkolnik, and Aaron Jacobs (2021). cancensus: R
  package to access, retrieve, and work with Canadian Census data and
  geography. v0.4.2.
  
10. Jared E. Knowles (2020). eeptools: Convenience Functions for Education Data.
  R package version 1.2.4. https://github.com/jknowles/eeptools  
  
11. Fitness Tracker Info Hub (2022). https://fitnesstrackerinfohub.netlify.app/

12. Unicode.org (2022). https://unicode.org/emoji/charts/full-emoji-modifiers.html

_You don't need to cite course materials, but consider all the the places you got data from, as well as the packages used and R itself. These are all things you should consider citing. Likewise, you might use some external resources on the emoji skin tones/Fitzpatrick scale, etc._

\newpage
# Appendix

Appendix should have the tables which support was was said in the main body. 
_These appendices should outline in more detail the steps taken to access the following datasets. They should NOT include code, but should briefly describe the steps and important considerations. I.e., show that you understand what needs to be considered when web scraping, protecting licensed data, etc._

The following table helps show the relationship between an individual's age and the flags they got. We see that younger age groups tend to have a higher mean number of flags and rate of flags per minute of sleep. However, the variances for each age group are quite large, showing that there may be some inaccuracy in the relationship between the variables. 
```{r, echo = FALSE}
cust_full %>%
    group_by(age_group) %>%
    dplyr::summarize(MeanCount = mean(flags, na.rm=TRUE),
              VarCount = var(flags, na.rm=TRUE),
              MeanRate = mean(flags/duration, na.rm=TRUE),
              VarRate = var(flags/duration, na.rm=TRUE),
              n = n()) %>% 
  knitr::kable(booktabs=T, 
        caption = 'The mean and variance of flags in slap by skin tone emoji.')
```

## Web scraping industry data on fitness tracker devices

## Accessing Census data on median household income

## Accessing postcode conversion files


__Final advice: KNIT EARLY AND OFTEN!__
