---
title: "Report on MINGAR Customers and Device Functionability"
subtitle: "Newer Affordable Devices are More Popular Among Lower Income People, MINGAR devices Over-Flag Darker Skinned People"
author: "Report prepared for MINGAR by Arpesso"
date: 2022-04-07
lang: "en"
output:
  pdf_document:
    template: report.tex
    toc: true
    toc_depth: 2
titlepage: true
titlepage-color: "6C3082"
titlepage-text-color: "FFFFFF"
titlepage-rule-color: "FFFFFF"
titlepage-rule-height: 2
---

```{r, message = FALSE, echo=FALSE}
# install.packages("eeptools")
# install.packages("cancensus")
# install.packages("haven")
library(tidyverse)
library(lme4)
library(rvest)
library(polite)
library(lmtest)
library(mgcv)
library(gridExtra)
library(knitr)
library(lattice)
# this should suppress all code and messages
# knitr::opts_chunk$set(include=FALSE)
```


\newpage
# Executive summary

### Background and Aim

MINGAR is a wearable technology company that operates in many different industries. 

As MINGAR looks to grow in a new market,they have asked us to conduct research on the relationship between customer characteristics and the decision to purchase newer affordable fitness devices. After creating the model and forming analysis and summaries, we found that there was a relationship between a household's income class and their age with respect to buying more affordable fitness trackers. 
Also, MINGAR has received complaints about discriminatory devices: Darker skinned users receive worse sleep scores than their lighter skinned counterparts. They have asked us to investigate this by comparing the relationship between sleep quality flags and user's skin tones. We found that individuals with darker skin tones have a higher flag count per minute, therefore a worse sleep score, than users with lighter skin tones. 

### Key Findings

* After accounting for age, we found that middle income households are 41.7% less likely than low income households to purchase the newer affordable products. 
* Also, we found that upper income households are 57% less likely than low income households to purchase the newer affordable products.
* _Finally, we found that as age increases each year, an individual is 0.5% more likely to buy the newer affordable products. 
* The average number of flags per minute of sleep for the medium-light skin tone is 2.173 times as high compared to the lightest skin tone. It is plausible that this value can be as high as 2.26.
* The average number of flags per minute of sleep for the medium skin tone is 3.248 times as high compared to the lightest skin tone. It is plausible that this value can be as high as 3.37. 
* The average number of flags per minute of sleep for the medium-dark skin tone is 6.62 times as high compared to the lightest skin tone. It is plausible that this value can be as high as 6.86. 
* The average number of flags per minute of sleep for the darkest skin tone is 10.913 times as high compared to the lightest skin tone. It is plausible that this value can be as high as 11.29.

### Limitations

* We could not include people who do not completely fill out their census data. This could cause bias in the report_
* We are defining income classes based on the percentiles within our data set rather than using actual classification like Canadian tax brackets. There may be more accurate ways to describe the income classes._
* There was no way to determine the actual race of the users whose skin tone was missing in the dataset, which meant the default skin tone. This could cause bias in the model.
* We could not include in the model people who did not have their sex reported. Consequently, this could cause bias in the model.
* We encountered a slight overdispersion in the sleep score data. This could cause biased coefficients. 

```{r,echo=FALSE}
socialmedia_data <- read_csv("data/socialmedia_data", show_col_types = FALSE)
#table 1:

Variable <- c("Intercept", "Medium-Light Skin Tone", "Medium Skin Tone", "Medium-Dark Skin Tone", "Dark Skin Tone", "Age")
Estimate <- c(0.003, 2.173, 3.248, 6.62, 10.913, 0.951)
Lower_CI <- c(0.003, 2.09, 3.13, 6.39, 10.55, 0.99) # change as ive scaled age
Higher_CI <- c(0.003, 2.23, 3.37, 6.86, 11.29, 1) # change as ive scaled age

Table <- data.frame(Variable, Estimate, Lower_CI, Higher_CI) # label this better, call it confidence interval, and remove the _

Table # put caption!

```


```{r,fig.height=3, echo=FALSE, fig.cap = "Proportion of the Number of Flags by Skin Tone}
#figure 1:
ggplot(data = socialmedia_data, aes(x = flags, fill = emoji_modifier)) +
  geom_bar(position = "fill") +
  scale_fill_grey() +
  theme_minimal() +
  labs(fill = "Skin Tone", x = "Flags", y = "Proportion")
```


\newpage
# Technical report

## Introduction

MINGAR would like to improve the functionality of their devices and identify the customer base of their newer devices. They have the data on their devices and current customers, but need the data to be cleaned, analyzed, and reported in a succinct way in order for them to take action. 

In this report, we look for consumer characteristics that influence their purchasing decisions on the newer devices. We also investigate the claim that MINGAR devices are more faulty on darker skin.

The report is separated into four distinct sections: Research Question, Data, Methods, and Discussion. We discuss the methodology for cleaning the data for the analyses, modifying variables, and testing and preparing the generalized linear mixed models that answer the research questions. We prepare summary tables and plots to convey our findings, and visualize and analyze the data that shows the relationship between our variables of interest and possible explanatory variables. Finally, we discuss the key findings of the analyses, as well as the models' strengths and weaknesses. 


### Research questions

* Which groups of customers  are more likely or have higher odds than others to buy the affordable MINGAR fitness trackers? 

* After accounting for other variables and duration of sleep, are darker skinned MINGAR users flagged more often than lighter skinned users? 


## Mingar Devices are more likely to flag darker skinned users than lighter skinned Users

### The Data

In this report we create a model to find the relationship between the sleep scores of an individual and their skin tone, accounting for the duration of sleep. We use the MINGAR customer datasets, datasets on device, and data on sleep flags for people with MINGAR devices. We use the emoji variable as a proxy for skin tone. 

Our variable of interest is the number of flags during a night of sleep for each person. We see that the distribution of this variable is approximately poisson as it is right skewed with many values at 0. From the figure below it appears that people with darker skin tones get more quality flags during sleep than people of lighter skin tones.

```{r, fig.height=3, echo = FALSE, fig.cap = "Distribution of sleep disruption flags by skin tone"}
socialmedia_data %>%
  ggplot(data =., aes(x=flags, fill = emoji_modifier)) +
  geom_histogram()+ 
  theme_minimal() +
  labs(x = "Flags",
       y = "Count",
       fill = "Skin Tone") 
```

The following table shows the summary on number of flags for all wearers of the devices over the several nights. The count is the number of times that flags happened per night, and the rate is the number of flags per minute of sleep. We see that the mean and variance of both counts and rates for darker skinned people tends to be larger than lighter skinned people. This indicates that MINGAR might have a problem with darker skinned people getting flagged more often. As the mean and variance are close for the most part, we can assume that this assumption for the poisson distribution is satisfied.  

```{r, echo = FALSE}
socialmedia_data %>%
    group_by(emoji_modifier) %>%
    dplyr::summarize(MeanCount = mean(flags, na.rm=TRUE),
              VarCount = var(flags, na.rm=TRUE),
              MeanRate = mean(flags/duration, na.rm=TRUE),
              VarRate = var(flags/duration, na.rm=TRUE)) %>%
  knitr::kable(booktabs=T,
               col.names = c("Skin Tone", "Mean Count", "Variance of Count", "Mean Rate", "Variance of Rate"),
             caption = 'The mean and variance for number of flags and rate of flags by skin tone.') 
```

Looking at the proportion of people in the data, we see that lighter skinned people have more sleep devices than darker skinned people.

```{r, echo = FALSE}
with(socialmedia_data,(prop.table(table(emoji_modifier)))) %>% 
  knitr::kable(col.names = c("Skin Tone", "Frequency"), caption = 'Proportion of people with sleep flag data in each skin tone group.')
```
### Methods

*state what types of model we're looking to assume, eg is it assumption for poisson, for glmm, etc* 

```{r,include = FALSE}
modrace2 = glmer(flags ~ emoji_modifier + scales::rescale(age, to = c(0,1)) + (1 | cust_id), family='poisson', offset = log(duration), data= socialmedia_data)
modrace = glmer(flags ~ emoji_modifier + sex + scales::rescale(age) + device_name + (1 | cust_id), family='poisson', offset = log(duration), data= socialmedia_data)
summary(modrace)
summary(modrace2)

```
```{r, include = FALSE}
lmtest::lrtest(modrace2, modrace)
```

To create the main dataset, we merged the customer information data, the sleep data, and the customer device data. To create the possible explanatory models, we created an age variable by subtracting the date of birth of the individual from the date of analysis; March 30th 2022. We renamed the emoji variables to understandable skin tones, and removed all missing values in this variable. We dropped all missing values for the sex variable to make the two possible explanatory models formed comparable in size. we rescaled the age variable to be confined only to values within 0 and 1, which was done to solve errors in creating the model. 

We used generalized linear mixed models to estimate the relationships between sleep flags and explanatory variables. We used this model as our response is not of the normal distribution, and we have a random effect we need to account for. We want to use this model to estimate the sleep scores for the entire population of MINGAR device users and not simply this sample.

To determine the variables which affected sleep scores, our first possible model included all the biological characteristics of the individual as well as a variable for the device, to make sure that the problem was not caused by problems inherent to the type of device, or other characteristics of the individual. These variables were skin tone, sex, age, the customer id random effect, and the device type. Running the summary on this model showed that the sex of the individual and the device type were statistically insignificant at a 5% significance level. 

Our second model only included the variables on skin tone and age, with the customer id random effect. Running the model showed both these variables as statistically significant at a 5% level. We used a restricted maximum likelihood ratio test (REML) to compare the two models because we are comparing models with the same random effect, and the assumptions needed for this type of test do not include normality or independence.

The maximum likelihood ratio test ran under the null hypothesis that the model involving only skin tone and age explained the response just as well as the model than included the other variables as well. Our p value cut off for rejecting the null was 0.05. The test revealed that at a p value of 0.2137, there was no evidence against the null hypothesis. A residual plot of this model shows that the residual plots look scattered with no fanning, indicating constant variance of errors. 

Due to the poisson nature of the response, when analyzing our model results we exponentiated the results  in order to interpret the coefficients. Additionally, 95% confidence intervals for each coefficient were created, to give us a range of plausible coefficient values as opposed to just the single estimate we originally had. 
We use a kruskal-wallis test to check if the mean number of flags was similar across different skin tones. We used this type of test as it does not assume that the response is normally distributed, and it allows to test the differences between more than two groups.

Our final model is
$$ Y_{ij} \sim Poisson(\lambda_{ij})  $$
$$ log(\lambda)_i = \beta_0 + \beta_1\alpha_{1i} + \beta_2\alpha_{2i} + \gamma_{i} + log(duration)_{ij} + U_i$$ 
$$ U_i \sim N (0, \sigma^2)$$

Where:
*$Y_{ij}$ is the number of flags that person i gets on night j. 

* $\lambda_{ij}$ is the mean number of flags for person i. 

* $\alpha_{1i}$ is the skin tone of person i. This is a fixed effect. 

* $\alpha_{2i}$ is the age of person i. This is also a fixed effect.

* $\gamma_{i}$ is the customer id of person i. This is a random effect added to account for the fact that flags for the same person will likely not be independent.

* $duration_{ij}$ Is the duration of sleep of person i on night j. This offset is used to account for the different lengths of sleep for different people on seperate nights, meaning they may have different rates of flags. 

* $U_i$ is the error term. 

As our model is of the generalized linear mixed nature, we need to make sure it satisfied both the poisson model and generalized linear mixed model assumptions. We previously confirmed the assumptions from the graph and table that the sleep flags are of the poisson distribution. We assume that the people who purchased the sleep are independent of each other. As the different flags that each subject gets are likely not independent, we use a random effect to account for the violation of independence. We assume that the residual errors come from a normal distribution and have a constant variance, proven by the residual plot. As we have shown that the flag distribution is poisson, we assume that the log link used to link this response to the explanatory variables is correct. However, we cannot assume that our random effect is normal.


### Results

We perform a non-parametric test to check if the proportion of people being flagged is similar across skin color. The null hypothesis is that the mean number of flags for each group is the same. However as the p value is $2.2e^{-16}$, we reject the null hypothesis and determine that some groups get flagged more than others. That is, skin tone does have an effect on the number of flags a person gets. 

```{r,include=FALSE}
# Are the proportions of people being flagged similar across race?

kruskal.test(flags ~ emoji_modifier, data = socialmedia_data)
```


The following table shows the results of the regression with our chosen model. The table includes the point estimates, as well as the 95% confidence interval range which gives the range of plausible values that each estimate could take. 

We have set the lightest skin tone as the base factor level. We see holding age constant and accounting for the duration of sleep and dependence of observations within the same individual, that the darker the subject's skin is, the more likely that they get flagged.
The average number of flags for medium-light skinned people, medium skinned people, medium-dark skinned people, and dark skinned people are 2.173, 3.248, 6.624, and 10.913 times higher than the average number of flags for light skinned people respectively. The confidence intervals show that even with 95% confidence darker skinned users get flagged more often. 
A secondary observation is that a one standard deviation increase in age is associated with a 4.9% decrease in the mean number of flags, from which we can see that holding skin tone constant, the older one gets, the less that they are flagged. 


```{r,cache = TRUE, include = FALSE,eval=FALSE}
confidence = confint(modrace2)
# estimates
ests <- format(round(exp(summary(modrace2)$coeff)[,1], 3), nsmall = 2)


# Get your confidence intervals
cis <- format(round(exp(confidence),3)[-1,], nsmall = 2)


## But make it even prettier
cis_pretty <- str_c("(", trimws(cis[,1]), ", ", cis[,2], ")")
cis_pretty

# What are the nice names for the rows and columns?
rownames_for_table <- c("Intercept", "Dark Skin Tone", "Medium Skin Tone", "Medium-Dark Skin Tone", "Medium-Light Skin Tone","Age")
colnames_for_table <- c("Estimate", "95% Confidence Interval")
```

```{r, echo = FALSE,eval=FALSE}
table <- cbind(ests, cis_pretty)
rownames(table) <- rownames_for_table
colnames(table) <- colnames_for_table

knitr::kable(table, align = c("r", "r"),caption = "Estimate and 95% confidence intervals for the average number of flags per night")
```


The following plot helps visualize the previous results. We see that the lightest skin tone mainly hangs around the low end of the number of flags, with about 50% of people with 0 flags having this skin tone. The proportion of people with a low number of flags decreases as the skin tone gets darker. We see that the two darkest skin tones make up the largest proportion of people who get many quality flags a night. 

```{r, fig.height=3, echo = FALSE, fig.cap = "Proportion of People with flags by skin tone"}
ggplot(data = socialmedia_data, aes(x = flags, fill = emoji_modifier)) +
  geom_bar(position = "fill") +
  scale_fill_grey() +
  theme_minimal() +
  labs(fill = "Skin Tone", x = "Flags", y = "Proportion")
```

This plot shows the estimated relationship between the log mean value of flags and the age of the person. The plot also shows the confidence intervals around the line. The log of the y axis is taken due to the poisson nature of the response. Due to the negative slope, we see that the younger one is, the more likely they are to have a larger mean number of flags. Thus there is a negative relationship between these two variables, holding skin tone constant. 

```{r,fig.height=3, echo = FALSE, fig.cap = "Mean number of Flags by Age"}
plot <- socialmedia_data %>% group_by(age) %>% 
  summarise(mnflag = mean(flags),
            logmnflag = log(mnflag), n=n())
ggplot(plot, aes(x=age, y=logmnflag)) +
  geom_point()+
  geom_smooth(method = "loess", size = 1)+
  xlab("Age of the person") +
  ylab("Log of the empirical mean number of flags") +
  theme_minimal()
```



## Lower income people and older people are more likely to purchase the newer, more affordable devices

* _Affordable items are defined True when products are of the lines "Active" or "Advance" and False otherwise._
* _This makes Affordable items a binomial variable so we can use the binomial distribution for the model._
* _We define differences in customers by their income, age, gender,and specific device features by model._
* _We define income group based on the Quantiles of the dataset._

### The Data

In this report we create a model to find the relationship between purchasing the new fitness trackers and characteristics of the buyer, accounting for the fact that people in the same postal code may have similar purchasing patterns. We use the MINGAR customer datasets, census data, postcode data, and a dataset on MINGAR devices. “Affordable”, a variable that is True if a purchased fitness tracker was affordable and was of the line Advance or Active and False otherwise, will be the response variable for the model.

From this data, we see that all the variables are either bernoulli or binomially distributed. We also see that most purchasers of total MINGAR devices are between the ages of 25 to 50, middle class, and female. 

```{r,fig.height=3, message=FALSE, warning=FALSE, include = TRUE, echo = FALSE, fig.cap = "Visualizing the response and key variables" }

marketing_data <- read_csv("data/marketing_data", show_col_types = FALSE)

# create a visualization
plot1 = marketing_data %>%
  ggplot(aes(x = affordable, fill = affordable)) +
  geom_bar() +
  labs(x = "Purchased Active or Advance Lines",
       y = "Count") +
  theme_minimal() +
  theme(legend.position = "none")

plot2 = marketing_data %>%
  ggplot(aes(x = age)) + 
  geom_histogram(bins = 5, fill = "dodgerblue1") +
  theme(legend.position = "none")+
  labs(x = "Age",
       y = "Count") +
  theme_minimal() +
  theme(legend.position = "none")

plot3 = marketing_data %>%
  ggplot(aes(x = income_class, fill = income_class)) +
  geom_bar() +
  theme(legend.position = "none") +
  labs(x = "Income Class",
       y = "Count") +
  theme_minimal() +
  theme(legend.position = "none")

plot4 = marketing_data %>%
  ggplot(aes(x = sex, fill = sex)) + 
  geom_bar() +
  theme(legend.position = "none") +
  labs(x = "Sex",
       y = "Count") +
  theme_minimal() +
  theme(legend.position = "none")

plot5 = marketing_data %>%
  ggplot(aes(x = pronouns, fill = pronouns)) +
  geom_bar() +
  theme(legend.position = "none") +
  labs(x = "Pronouns",
       y = "Count") +
  theme_minimal() +
  theme(legend.position = "none")

plot6 = marketing_data %>%
  ggplot(aes(x = released)) + 
  geom_bar(fill = "lawngreen") +
  theme(axis.text.x = element_text(angle = 320),
        legend.position = "none") +
  labs(x = "Year Released",
       y = "Count") +
  theme_minimal() +
  theme(legend.position = "none")

grid.arrange(plot1,plot2,plot3,plot4,plot5,plot6, ncol=2)

```

### Methods
*state datasets that were merged*

A generalized linear mixed model was created.  As our response variable only contains observations of "True" or "False", it is of the binomial family. Thus our generalized linear model uses a logit link function, and the model tells us about the relationship between our predictor variables and the response. We have a random effect we need to account for, which is the postal code, as purchasing patterns for people in the same postal code may be similar depending on if the area is lower or higher income. Since we would like to make claims about the entire population of customers as opposed to just those in our sample, we must use the different customers in our sample as random effects since each person differs. Thus, our model needs to be a generalized linear mixed model.  


With this in mind, our model will be of the following form:

$Y_i \sim Bernoulli(\rho_i)$
$logit(\rho_i) = \beta_0 + X_{i}\beta + U_i$
$U_i$ ~ $N(0, \sigma^2)$, where:

beta 0 is intercept, when age is 0 and income is poor
* _$Y_i$ is whether a customer i, purchases a Affordable fitness tracker or not_
* _$X_i$ are the indicator variables for the fixed effect_ 
* _$\beta$ is the coefficient matrix for the fixed effects_
* _$\mu$ is the intercept of the model_
* _$U_i$ are the random effects of each postal code/customer_

Each of our units and customers are independent from each other and have no effect on each others answers and values, satisfying the independence assumption. Additionally, our chosen link function is correct as "Affordable" is most clearly a binary variable with a Bernoulli distribution satisfying the distribution assumption.  The residual errors look binomial, so we can assume that the variance is binomial. However, our random effect is not of the normal distribution. *add more assumptions*

Our age variable was created by subtracting the date of birth of the individual from the date of analysis. Income class was created by getting the census data and postal code data, getting the mean income from the postcode, and then segmenting these values into three different groups.  Income class is a categorical variable that is based on the average median household income of all individuals in the same postcode. This gives us an idea of the financial situation of a customer based on where they live. 

To determine which variables affect whether a customer buys affordable fitness trackers, different models were tested against each other. The test used to compare models is a restricted maximum likelihood ratio test (REML), which estimates random effects based on the fixed effects. This REML test has been chosen since we are comparing models with the same random effect (postal codes), and the assumptions for normality and independence aren't held. The REML test will be run under the null hypothesis that the two models being compared fit our data equally as good as each other. A smaller p-value below 0.05 (our significance level) means there is evidence against the null hypothesis. 

The coefficients of our variable are exponentiated into the odds ratio, to be interpretable. Additionally,the 95% confidence intervals for each coefficient will be created and also exponentiated, where the upper and lower bound of the interval will be obtained. The reason we create these intervals is to give us a range of plausible coefficient values in addition to the singular estimate. 


```{r, cache=TRUE, warning=FALSE, include = FALSE}
market_model1 = glmer(affordable ~ factor(income_class) + (1 | postcode),
                         data = marketing_data, family = "binomial")

market_model2 = glmer(affordable ~ factor(income_class) + age + (1 | postcode),
                        data = marketing_data, family = "binomial")

market_model3 = glmer(affordable ~ factor(income_class) + age + sex +(1 | postcode), data = marketing_data, family = "binomial")

lrtest(market_model1,market_model2)
lrtest(market_model2,market_model3)

summary(market_model2)
```

In the creation of the model, the first fixed effect added was income class. We added the age variable for the second model, and compared the two models. Testing the model gave a very low p-value  of $5.656*10^{-9}$. Thus there is evidence against the null hypothesis that the simpler model without age fits the data as well as the model with age, meaning age and income should be included in the model. Another model was created,adding the sex variable to the model. The model was tested against the simpler Income Class and Age model. The test outputted a p-value of 0.2059. Thus there is no evidence against the null hypothesis stating the simpler models without sex explain the data just as well as the data including sex. So in our final model, the fixed effects are income class and age, while the random effect is the postcode. 

## Results 

We perform a kruskal-wallis non-parametric test to check if the proportion of people buying new devices are is similar across income class. The null hypothesis is that the likelihood of buying the newer devices across the groups is the same. As the p value is $2.2e^{-16}$, we reject the null hypothesis and determine that some groups are more likely to buy the newer devices than others. 

```{r,include=FALSE}
# Are the proportions of people buying the newer affordable devices similar across income?

kruskal.test(affordable ~ factor(income_class), data = marketing_data)
```

Below, is the results table, containing the estimated exponentiated coefficients and confidence intervals for each fixed effect, as well as the intercept.As our confidence intervals are narrow, our estimates are precise. 

The intercept value is not meaningful as this means that the base age for purchasing a newer device would be at 0. The estimated coefficient of the fixed effect for middle class customers is 0.583. This tells us that customers of the middle income class are 41.7% less likely to buy the newer affordable devices compared to those in the lower income class, holding age constant. With an estimated coefficient of 0.43, upper class people are 57 % less likely to buy the newer devices, holding age constant. We thus see that a higher income class causes customers to buy less affordable products, holding age constant and taking into account the dependence of individuals living in the same postcode. The confidence intervals show that it is plausible that the decreased likelihood is within these ranges of values. 
The  estimate for age  was 1.005,meaning that for each additional age,the likeliness of the customer buying the newer affordable devices increases by 0.5%, holding income class constant. This means that the older as customer is, the more likely that customer is to buy an affordable fitness tracker or smartwatch.

```{r, cache=TRUE,eval=FALSE}
confint <- confint(market_model2)

exp_coef <- exp(summary(market_model2)$coeff[,1])
exp_confint <- exp(confint(market_model2))
```

```{r, message=FALSE, warning=FALSE, include = TRUE, echo = FALSE,eval=FALSE}
cis_pretty <- str_c("(", trimws(round(exp_confint[2:5,1], 3)), ", ", round(exp_confint[2:5,2],3), ")")

market_table <- cbind(round(exp_coef,3), cis_pretty)
rownames(market_table) <- c("Intercept", "Middle Class", "Upper Class", "Age")
colnames(market_table) <- c("Estimate", "95% Confidence Interval")

kable(market_table, align = c("c", "c"))
```



The following plot helps visualize the previous results. We see that nearly 75% of lower income people who owned a MINGAR device owned the newer affordable device. The proportion of middle income people that own the newer devices is only just above 50%, and for high income people is less than 50%. This shows that the richer a person is, the less likely that they own a newer device. 

```{r,fig.height=3, echo=FALSE, fig.cap = "Proportion of People in each Income class who Purchased the Newer Devices"}
ggplot(data = marketing_data, aes(x = factor(income_class), fill = affordable)) +
  geom_bar(position = "fill") +
  scale_fill_grey() +
  theme_minimal() +
  labs(fill = "Owns New Device", x = "Income class", y = "Proportion")
```


This plot shows the estimated relationship between the log mean value of the decision to buy the newer affordable products, and the age of the person. The plot also shows the confidence intervals around the line, segmented by income class. The log of the y axis is taken due to the bernoulli nature of the response. Due to the positive slope, we see that the older one is, the more likely they are to purchase the new affordable devices. We also see that the regression line for the lower class customers is higher than those of the middle class and upper class customers. Thus there is a positive relationship between age and the decision to buy newer products, and poorer customers are more likely to purchase the newer products. 

```{r,fig.height=3, echo=FALSE, fig.cap = "Mean value of the Purchase decision by Age, grouped by Income Class" }
emplogit2 <- marketing_data %>%
  group_by(income_class, age) %>%
  summarise(propnew = mean(affordable), n = n()) %>%
  mutate(propnew = ifelse(propnew==0, .01, propnew)) %>%
  mutate(emplogit = log(propnew / (1 - propnew)))
ggplot(emplogit2, aes(x = age, y = emplogit, color = income_class)) +
  geom_point(aes(shape = income_class)) +
  geom_smooth(aes(linetype = income_class), method = "lm") +
  labs(x = "Age",
       y = "Empirical logits",
       color = "Income Class") +
  theme_minimal() 
```


## Discussion

### Findings

For the characteristics of new customers,it is confirmed that a customer's age and income class play a large factor in how their purchasing decisions differ. The higher the income of the customer's neighborhood, the less likely that they purchase the newer products. We found that middle class and upper class income customers are respectively 41.7% less likely and 57% less likely to buy the newer devices compared to lower class customers. It was also determined that the chances of buying an affordable product increases as a customer becomes older in age. As a person's age increases by 1, they are 0.5% more likely to purchase the newer devices compared to their previous age. So, overall, customers buying affordable devices differ from those buying non-affordable ones as they likely are older of age and living in a lower income class neighborhood.

For the relationship between sleep scores and skin tone, we have confirmed that MINGAR devices flag darker skinned people more often than lighter skinned people, holding  age constant. We find that the average number of flags during sleep for medium-light, medium, medium-dark, and dark skinned people are 2.173, 3.248, 6.624, and 10.913 times higher than the average number of flags for light skinned people respectively. The sleep scores decline exponentially as the skin tone gets darker. This accounts for the duration of sleep, and the dependency of sleep scores for the same individual. We have also found that the age of the individual affects the average  number of flags they get, with a one standard deviation increase in age being associated with a 4.9% decrease in the mean number of flags, skin tone held constant. 

### Strengths and limitations

The major strengths of the customer characteristics model and analysis is the versatility and information this model provides on consumer behavior and consumption. Mainly, we know that lower income families have much greater odds to purchase more affordable smart watches than middle class and upper class families, and that older people will have higher odds to buy affordable smart watches. So, the marketing team of Mingar can shift their focus and advertising more to that market in regards to the affordable lines of 'active' and 'advance.' 

The strengths of the skin tone model include the fact that we used a random effect of the individual to account for that fact that observations were likely not independent for each individual. This helps us to generalize our results for the population, and not just this specific sample. We also decided to add an offset of duration, which accounts for the fact that rates of flags for each night could be different. Another strength includes the rationale for the model, which used the poisson distribution and not the normal distribution, to match with the response. A final strength is only including biological characteristics for the customers, as the sleep trackers work off of biological qualities such as skin tone. 

A limitation of this analysis is that we dropped all the cases where a person's sex or pronouns were not included. This reduced our sample, which could possible introduce some bias to our model if the missing values were not randomly distributed. In future work we could try to collect better data on this variable.  

Another limitation of our model is from how we defined some of our variables used in the model. We defined income classes based of the percentiles within the data rather than following a standard, like the Canadian Tax bracket, because the ranges of these classifications tend to make all observations heavily lean towards only one factor of the bracket. Many of these brackets cite that `$`50 000 to `$`100 000 as one factor, but that range contains over 98% of the observations.

Another limitation was from defining the household median income. Most postcodes corresponded with multiple 'CSDuid' which meant that a single postcode also responds to many different median household incomes. To account for this, we took the average of all the median household incomes for when 'CSDuid' corresponded with the same postcode to create a new median household income for each postcode. All of these definitions may contribute inaccuracy to our data which could then affect the validity of the model. 

Another limitation is that we assumed those who lived in lower income neighbourhoods were lower income and those that lived in higher income neighbourhoods are higher income, but this is not always the case. This inaccuracy could lead to bias in the model.

An assumption for the general linear mixed model is that the random effect follows the normal distribution, but since there is only one of each postal code in our dataset, the random effects will instead be uniform. Thus the assumption is broken, which means the model results may be inaccurate. In future work we could use a gam model, which accounts for this problem. 

The first major limitation for the sleep scores model is that the missing values (default skin tone emoji) was not accurate to the actual skin tone of the individual. As their true skin tone was not recorded, these individuals were dropped from the model, and analysis created is most likely biased as we dropped a large number of the observations. 

Another limitation is that while the mean and median flags for each skin tone was close, they were not very close. This may violate the poisson assumption  that mean most always be equal to variance. This means that there is overdispersion of coefficients (coefficients reported are larger than their true variable). In future work we can use the form of the generalized poisson model that accounts for over dispersion. 

We also dropped all observations in which sex was missing. This could cause bias in the model if the missing variables were not randomly distributed. In future work we could collect better data on this variable.  

A main assumption for the type of model used is that the random effects need to come from a normal distribution. However as our random effects was the customer id, which is unique to each customer, the distribution is uniform. Thus our estimates are likely biased. 

\newpage

# Consultant information

## Consultant profiles

**Thomas D'Onofrio**. Thomas is a senior consultant with Arpesso. He specializes in linear modelling. Thomas earned his Bachelor of Science, Specialist in Statistics Methods and Practice, from the University of Toronto in 2023.

**Pablo Mercado**. Pablo is a junior consultant with Arpesso. He specialize in reproducible analysis and statistical communication. Pablo earned their Bachelor of Science, Majoring in Computer Science and Statistics from the University of Toronto in 2022.

**Olaedo Okpareke**. Olaedo Okpareke is a senior consultant at Arpesso. She specializes in statistical analysis and data visualization in R and Python. She also specializes in statistical surveys and sampling, as well as financial risk analysis. Olaedo earned her Bachelor of Science in Economics and Statistics from the University of Toronto in 2023, and her masters in Economic Data analysis from University of Toronto in 2026. 

**Walid Roudani**. Walid Roudani is a senior consultant with Arpesso. He specializes in reproducible analysis, statistical communication, as well as team organization. Walid has earned both his Bachelor of Science in Economics and Statistics from the University of Toronto in 2023, as well as his masters degree in Economics at the University of Toronto in 2026.

## Code of ethical conduct

In our report, we represented all summaries and visualizations honestly. We did not create any misleading visualizations. When modifications to variables were made, they were very explicitly stated and justified. We stated clearly all limitations of the analysis, and any failings of our method. 

We did not disclose any personal customer information from MINGAR to any third party, as disclosed by the Non-disclosure agreement. All confidential information was analyzed solely by the statistic consultants for the report at Arpesso. As no consent was given by MINGAR to spread the customer information, and was not directed by the court of law, the information was kept confidential. Due to this, we have removed the postcode data and the census API key. 

While scraping the data required for our report, we made sure to uphold the rights of the owner by providing a user agent string for further inquiries, and so that our requests are made clear. We scraped the data at a timely rate, made sure to not pass the data off as our own, and scraped to create new datasets from the data, not to duplicate it. 

All sensitive customer information was kept anonymous. Arpesso did not attempt to use the information to identify individuals. To uphold customer's privacy, all personal information was used solely for the purpose of analysis and no non-essential identifying information was used.

\newpage
# References

1. R Core Team (2021). R: A language and environment for statistical computing.
  R Foundation for Statistical Computing, Vienna, Austria. URL
  https://www.R-project.org/.
  
2. Wickham et al., (2019). Welcome to the tidyverse. Journal of Open Source
  Software, 4(43), 1686, https://doi.org/10.21105/joss.01686
  
3. Douglas Bates, Martin Maechler, Ben Bolker, Steve Walker (2015). Fitting
  Linear Mixed-Effects Models Using lme4. Journal of Statistical Software,
  67(1), 1-48. doi:10.18637/jss.v067.i01.

4. Hadley Wickham (2021). rvest: Easily Harvest (Scrape) Web Pages.
  https://rvest.tidyverse.org/, https://github.com/tidyverse/rvest.
  
5. Dmytro Perepolkin (2019). polite: Be Nice on the Web. R package version
  0.1.1. https://github.com/dmi3kno/polite  
  
6. Achim Zeileis, Torsten Hothorn (2002). Diagnostic Checking in Regression
  Relationships. R News 2(3), 7-10. URL https://CRAN.R-project.org/doc/Rnews/
  
7. Sam Firke (2021). janitor: Simple Tools for Examining and Cleaning Dirty
  Data. R package version 2.1.0. https://github.com/sfirke/janitor
  
8. Hadley Wickham and Evan Miller (2021). haven: Import and Export 'SPSS',
  'Stata' and 'SAS' Files. https://haven.tidyverse.org,
  https://github.com/tidyverse/haven, https://github.com/WizardMac/ReadStat.
  
9. von Bergmann, J., Dmitry Shkolnik, and Aaron Jacobs (2021). cancensus: R
  package to access, retrieve, and work with Canadian Census data and
  geography. v0.4.2.
  
10. Jared E. Knowles (2020). eeptools: Convenience Functions for Education Data.
  R package version 1.2.4. https://github.com/jknowles/eeptools  
  
11. Fitness Tracker Info Hub (2022). https://fitnesstrackerinfohub.netlify.app/

12. Unicode.org (2022). https://unicode.org/emoji/charts/full-emoji-modifiers.html

13. Baptiste Auguie (2017). gridExtra: Miscellaneous Functions for “Grid” Graphics. R package version 2.3.

14. Sarkar, Deepayan (2008) Lattice: Multivariate Data Visualization with R. Springer, New York. ISBN
978-0-387-75968-5.

15. Wood, S.N. (2011) Fast stable restricted maximum likelihood and marginal likelihood estimation of semiparametric generalized linear models. Journal of the Royal Statistical Society (B) 73(1):3-36.

16. Yihui Xie (2021). knitr: A General-Purpose Package for Dynamic Report Generation in R. R package version
1.37.

\newpage
# Appendix

_These appendices should outline in more detail the steps taken to access the following datasets. They should NOT include code, but should briefly describe the steps and important considerations. I.e., show that you understand what needs to be considered when web scraping, protecting licensed data, etc._

## Web scraping industry data on fitness tracker devices
put eval = false and censor the api key

The data on fitness devices was scraped from https://fitnesstrackerinfohub.netlify.app/. We used the `polite` package and the bow function to tell the website our user agent data, and to receive details from the robot text file on crawl delays. We scraped the data as there was no publicly provided API. From the robots.txt, we found that web scraping was allowed for the web page, with a rate limit of 12 seconds.  Next, we used the `rvest` package and scrape function to scrape the data we need following the specifications from the robot text file. We used a user agent string to make our intentions clear, and to provide a point of contact with the consultants that the owners of the web page could use.   Finally, we took the data that from the html format and transformed them into table to be used for our research. 

## Accessing Census data on median household income

The Census data on median household income was retrieved from The Statistics Canada 2016 census, through the website API of the Canadian census mapper. To begin, we signed up a user account on their website to be given the API key needed to access their data. Next, we installed and used the`cancensus` package, and used the API key that we were given to get the median household income. This was done by first finding the regions from the year 2016. We then filter those received regions to match the relevant census subdivisions in our customer data. Finally, we simplified the data set's variables to only the ones required for our analysis. 

## Accessing postcode conversion files

dont add postcode conversion code 

The postcode conversion files were retrieved directly from the Canadian Census postal code conversion files using our credentials as University of Toronto students. We chose the the most recently released data set from August 2021 because we wanted the most relevant and recent data to answer the research questions accurately. In the process of downloading this data, we agreed to a license agreement to use this data and have also chosen to not upload the raw data to our github. We only upload the processed data which can be analyzed to reproduce the report.


